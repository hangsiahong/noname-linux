version="0.33.0"
STAGE0_VERSION="0.33.0"
desc="The Rust package manager"
deps="cmake curl libgit2 libssh2 libressl python zlib rust"
source="https://github.com/rust-lang/cargo/archive/$version.tar.gz
https://repo.voidlinux.eu/distfiles/cargo-${STAGE0_VERSION}-x86_64-unknown-linux-musl.tar.gz"

ext() {
	mkdir -p stage0/bin
	mv cargo stage0/bin
	mkdir -p stage0/lib
	local libn=`ldd stage0/bin/cargo 2>&1 | grep library | cut -d ' ' -f 5 | sed 's/://'`
	ln -s /lib/libgit2.so stage0/lib/$libn
	mkdir .cargo
	cat > .cargo/config << "EOF"
[registry]
index="git://mirrors.ustc.edu.cn/crates.io-index"
EOF

	cd cargo-$version
	for i in $source; do
		case $i in
		*patch) patch -p1 < ../$i;;
		esac
	done
}

build() {
	cd cargo-$version
	export LIBGIT2_SYS_USE_PKG_CONFIG=yes
	export CARGO_HOME="$srcdir/.cargo"
	export LD_LIBRARY_PATH="$srcdir/stage0/lib"
	export PATH="$srcdir/stage0/bin:$PATH"
	export RUST_BACKTRACE=1

	cargo build $MAKEFLAGS --release --verbose
	install -D -m 755 target/release/cargo "$pkgdir"/bin/cargo
	mkdir -p "$pkgdir"/share/man/man1
	install -m 644 -t "$pkgdir"/share/man/man1/ src/etc/man/*.1
	install -D -m 644 -D src/etc/cargo.bashcomp.sh "$subpkgdir"/share/bash-completion/completions/cargo
}
