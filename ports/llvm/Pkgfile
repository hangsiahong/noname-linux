version="7.0.1"
nostrip=true
desc="LLVM compiler and its backend"
makedeps=["python", "cmake", "flex", "bison", "libffi", "libxml2"]
deps=["python", "libffi", "libxml2"]
source=[
	{url="http://llvm.org/releases/$version/llvm-$version.src.tar.xz"},
	{url="https://releases.llvm.org/$version/lld-$version.src.tar.xz"},
	{url="http://www.llvm.org/releases/${version}/cfe-${version}.src.tar.xz"},
	{url="http://www.llvm.org/releases/${version}/clang-tools-extra-${version}.src.tar.xz"},
	{url="http://www.llvm.org/releases/${version}/compiler-rt-${version}.src.tar.xz"},
	{url="cfe-001-fix-stdint.patch"},
	{url="cfe-003-fix-unwind-chain-inclusion.patch"},
	{url="llvm-001-musl.patch"},
	{url="llvm-config.h"}
]

ext='''
	cd cfe-$version.src
	for i in $source;do
		echo $i
		case $i in
		cfe*.patch) patch -p1 -i "$srcdir/$i";;
		esac
	done
	cd ..

	cd compiler-rt-$version.src
	for i in $source;do
		echo $i
		case $i in
		compiler-rt*.patch) patch -p1 -i "$srcdir/$i";;
		esac
	done
	cd ..

	wrksrc="`pwd`/llvm-$version.src"
	mv cfe-${version}.src ${wrksrc}/tools/clang
	mv clang-tools-extra-${version}.src ${wrksrc}/tools/clang/tools/extra
	mv compiler-rt-${version}.src ${wrksrc}/projects/compiler-rt
	mv lld-${version}.src ${wrksrc}/projects/lld
	sed -i 's/set(COMPILER_RT_HAS_SANITIZER_COMMON TRUE)/set(COMPILER_RT_HAS_SANITIZER_COMMON FALSE)/' ${wrksrc}/projects/compiler-rt/cmake/config-ix.cmake

	cd llvm-$version.src
	for i in $source;do
		echo $i
		case $i in
		llvm*.patch) patch -p1 -i "$srcdir/$i";;
		esac
	done
	rm test/tools/llvm-objdump/macho-compact-unwind-x86_64.test \
	test/tools/llvm-objdump/macho-compact-unwind-i386.test \
	test/Transforms/GlobalOpt/alias-used.ll \
	test/tools/llvm-symbolizer/print_context.c
'''

build='''
	cd llvm-$version.src
	mkdir -p build
	cd build

	cmake -G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX= \
		-DLLVM_BINUTILS_INCDIR=/include \
		-DLLVM_BUILD_DOCS=YES \
		-DLLVM_BUILD_TESTS=OFF \
		-DLLVM_LINK_LLVM_DYLIB=ON \
		-DLLVM_BUILD_LLVM_DYLIB=ON \
		-DLLVM_INSTALL_UTILS=ON \
		-DLLVM_ENABLE_FFI=YES \
		-DLLVM_ENABLE_RTTI=YES \
		-DLLVM_ENABLE_ZLIB=YES \
		-DLLVM_APPEND_VC_REV=NO \
		-DLLVM_DEFAULT_TARGET_TRIPLE="$TARGET" \
		-DLLVM_TARGETS_TO_BUILD='X86;AMDGPU;BPF' \
		-DFFI_INCLUDE_DIR="$(pkg-config --cflags-only-I libffi | sed 's|^-I||g')" \
		..
	
	ninja
	DESTDIR="$pkgdir" ninja install

	install -d "$pkgdir"/lib/bfd-plugins
	ln -s ../LLVMgold.so "$pkgdir"/lib/bfd-plugins/LLVMgold.so

	mv "$pkgdir"/include/llvm/Config/llvm-config.h "$pkgdir"/include/llvm/Config/llvm-config-64.h
	install -m 0644 "$srcdir"/llvm-config.h "$pkgdir"/include/llvm/Config/

	mv "$pkgdir"/libexec/ccc-analyzer "$pkgdir/lib/clang/"
	mv "$pkgdir"/libexec/c++-analyzer "$pkgdir/lib/clang/"
	rmdir "$pkgdir/libexec"
	sed -i 's|libexec|lib/clang|' "$pkgdir/bin/scan-build"
'''
