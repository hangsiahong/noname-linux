name=qt5-base
version=5.8.0
deps="dbus mesa libxi libxrender xcb-util-image xcb-util-keysyms xcb-util-wm libressl harfbuzz sqlite python libpng libjpeg-turbo zlib gtk hicolor-icon-theme icu alsa-lib fontconfig libinput pulseaudio"
source="http://download.qt.io/official_releases/qt/${version%.*}/$version/submodules/qtbase-opensource-src-$version.tar.xz
libressl-compat.patch
plasma-crash-1.patch
plasma-crash-2.patch
plasma-crash-3.patch
qt-musl-iconv-no-bom.patch
"
desc="Qt Free Edition, version 5.x"

build() {
	cd qtbase-opensource-src-$version

	for i in $source;do
		case $i in
		*qtbug*.patch) msg $i && patch -p1 -i $srcdir/$i || die;;
		*.patch) msg $i && patch -p1 -i $srcdir/$i || die ;;
		esac
	done
	CFLAGS="$CFLAGS -DOPENSSL_NO_SSL3_METHOD"
	CXXFLAGS="$CXXFLAGS -DOPENSSL_NO_SSL3_METHOD"

	sed -i '/OPENSSL_VERSION_NUMBER-0 >= 0x10002000L && !defined(OPENSSL_NO_EC) && !defined(SSL_CTRL_SET_CURVES)/,+2d' config.tests/unix/openssl/openssl.cpp || die

	# Respect system CXXFLAGS
	sed -i "s|^\(QMAKE_CFLAGS_RELEASE.*\)|\1 ${CXXFLAGS}|" mkspecs/common/gcc-base.conf
	sed -i "s|^\(QMAKE_LFLAGS_RELEASE.*\)|\1 ${LDFLAGS}|" mkspecs/common/g++-unix.conf

	./configure \
		-prefix / \
	 	-bindir /bin \
		-docdir /share/doc/qt \
		-headerdir /include/qt \
		-archdatadir /lib/qt \
		-datadir /share/qt \
		-sysconfdir /etc/xdg \
		-system-sqlite \
		-nomake examples \
		-system-harfbuzz \
		-no-use-gold-linker \
		-openssl-linked \
		-dbus-linked \
		-optimized-qmake \
		-nomake examples \
		-no-pch \
		-no-cups \
		-no-strip \
		-shared -no-rpath \
		-no-separate-debug-info \
		-no-reduce-relocations \
		-opensource -confirm-license

	make || die
	make INSTALL_ROOT=$pkgdir install || die
    
	# Drop QMAKE_PRL_BUILD_DIR because reference the build dir
	find "${pkgdir}/lib" -type f -name '*.prl' -exec sed -i '/^QMAKE_PRL_BUILD_DIR/d' {} \;
	sed -i "$pkgdir"/lib/qt/mkspecs/common/gcc-base.conf \
		-e '/^QMAKE_CFLAGS_ISYSTEM/s;-isystem;-I;'
}

post() {
	[ ! -f "$DB/gnome-themes-standard.metadata" ] && error "install qtstyleplugins to enable qtgtkstyle" || true
}
