# Template file for 'syslinux'
name=syslinux
version=6.03
deps="perl python nasm dosfstools efibootmgr util-linux gptfdisk"
desc="A boot loader for the Linux operating system"
source="http://kernel.org/pub/linux/utils/boot/$name/$name-$version.tar.xz
btrfs-fix.patch
correct_base_type.patch
dont-guess.patch
fix-alignment.patch
kdb.patch
set_mode_base.patch
"

ext() {
	cd syslinux-$version

	patch -p1 < ../fix-alignment.patch || die
	patch -p1 < ../dont-guess.patch || die
	patch -p1 < ../btrfs-fix.patch || die
	patch -p1 < ../kdb.patch || die
	patch -p1 < ../correct_base_type.patch || die
	patch -p1 < ../set_mode_base.patch || die
}

build() {
	cd syslinux-$version
	unset LDFLAGS
	make bios efi32 efi64 installer -j1 || die
	make bios efi32 efi64 install -j1 INSTALLROOT="$pkgdir" BINDIR=/bin PREFIX=/ SBINDIR=/bin MANDIR=/share/man AUXDIR=/lib/syslinux || die
	rm -r "$pkgdir"/lib/syslinux/com32
	rm -r "$pkgdir"/lib/syslinux/dosutil
	rm -r "$pkgdir"/lib/syslinux/syslinux.com

	install -d "$pkgdir"/share/doc
	cp -ar doc "$pkgdir"/share/doc/syslinux

	install -d "$pkgdir"/lib/syslinux/bios
	mv "$pkgdir"/lib/syslinux/*.bin "$pkgdir"/lib/syslinux/bios
	mv "$pkgdir"/lib/syslinux/*.c32 "$pkgdir"/lib/syslinux/bios
	mv "$pkgdir"/lib/syslinux/*.0 "$pkgdir"/lib/syslinux/bios
	mv "$pkgdir"/lib/syslinux/memdisk "$pkgdir"/lib/syslinux/bios
}
